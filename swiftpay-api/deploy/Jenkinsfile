pipeline {
    agent any

    environment {
        IMAGE_NAME = "swiftpay-api:latest"
        NAMESPACE = "swiftpay"
        DEPLOYMENT = "swiftpay-api"
        KUBECONFIG = "/etc/rancher/k3s/k3s.yaml" // Jenkins pod에서 마운트한 kubeconfig 경로
    }

    stages {
        stage('Build JAR') {
            steps {
                sh 'ls -la'
                sh 'ls -la ../'
                sh 'ls -la ../../'
                sh 'ls -la ../../../'
                sh './gradlew :swiftpay-api:build -x test --no-daemon'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME} ."
            }
        }

        stage('Push to Local Docker (Optional)') {
            steps {
                // 로컬 Docker만 사용하므로 생략 가능
                echo "Using local Docker, no push needed"
            }
        }

        stage('Deploy to K3s') {
            environment {
                KUBECONFIG = "${env.KUBECONFIG}"
            }
            steps {
                sh "kubectl --kubeconfig=${KUBECONFIG} -n ${NAMESPACE} rollout restart deployment ${DEPLOYMENT}"
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully!"
        }
        failure {
            echo "Deployment failed!"
        }
    }
}
